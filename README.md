# MIPS CPU

用 SpinalHDL 复刻 MIPS 五级流水线。

## 目录结构

- `src/main/scala`: 源代码目录
- `src/test/scala`: 仿真测试代码目录
- `verilog`: 生成的 Verilog 代码目录

## 流水线设计

经典 32 位 MIPS 五级流水线，跳转指令有延迟槽，在 D 级生效；乘除法器位于 E 级，用计数器模拟乘除延迟；访存在 M 级，寄存器回写在 W 级。 指令存储器 (IM) 和数据存储器 (DM) 位于 CPU 外部，CPU 自身通过顶层接口来取指令和读写存储器。

数据通路和指令分离，数据通路只包括指令计数器, 通用寄存器堆, 乘除法器等状态部件和流水线寄存器、转发阻塞单元。 其余所有的组合逻辑如 ALU，比较与跳转、访存地址生成和数据处理等均在指令类中定义，且由软件来生成。 （便于新增指令，但硬件资源消耗很大）

## 指令建模

一个指令一个类，包含：

- 指令编码
  - 识别码，`M` 类型 SpinalHDL 字面量，用于译码得到指令种类
- 转发暂停信息
  - 在哪一级用到寄存器数据
  - 在哪一级生成寄存器数据
- 在每个流水级的行为
  - 与流水寄存器中流水的数据接口交互
  - 每个指令在每个流水级相当于一个组合逻辑模块

然后用软件对每个指令在数据通路中生成相应的组合逻辑电路，并根据当前的指令种类以 MUX 选择指令结果。用 `when` 描述条件分支，利用多次 `:=` 赋值取最后一次的特性，构建 MUX 电路。

## 仿真测试

- 用 Scala 编写 "testbench"
- 调用 verilator/iverilog 或 VCS 作为后端运行仿真
